variables:
  DEPLOY_REPO: 'front-end-deploy'
  DEPLOY_REPO_URL: 'https://gitlab-ci-token:${GITLAB_USER_API_TOKEN}@gitlab.ebi.ac.uk/uniprot/front-end/${DEPLOY_REPO}.git'

stages:
  - build_docker_image
  - deploy

build_docker_image:
  only:
    refs:
      - dev
  stage: build_docker_image
  image: docker:20.10.14-git
  tags:
    - dind
  services:
    - docker:dind
  script:
    - git clone $DEPLOY_REPO_URL
    - cp $DEPLOY_REPO/docker/Dockerfile .
    - docker --version
    - git --version
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - CONTAINER_IMAGE=${CI_REGISTRY_IMAGE}/${CI_COMMIT_BRANCH}:latest
    - echo ${CONTAINER_IMAGE}
    - docker build -t $CONTAINER_IMAGE --no-cache .
    - docker image ls
    - docker push $CONTAINER_IMAGE
    - docker rmi $CONTAINER_IMAGE
    - docker logout "$CI_REGISTRY"

deploy:
  only:
    refs:
      - dev
  stage: deploy
  image: alpine/k8s:1.22.6
  script:
    - git clone $DEPLOY_REPO_URL
    - ./deploy/pre-deploy.sh HH uniprot-front-end-dev
    - helm upgrade --install -f ${DEPLOY_REPO}/uniprot-website-dev.yaml uniprot-website-dev $DEPLOY_REPO
    - ./deploy/post-deploy.sh
